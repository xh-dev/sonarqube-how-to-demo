### Introduction
This is a demo for starting up the `sonarqube` from docker environment.
The source code is on [[GitHub](https://github.com/xh-dev/sonarqube-how-to-demo)]

**Please be aware that this demo is not production ready, please double-check for any security issues before going to production with / based on this code base.**

**Clone the project with the below script.**
```shell
git clone https://github.com/xh-dev/sonarqube-how-to-demo.git
```

The IaC is achieved through the `terraform` and `ansible`. I use `terraform` for the cloud VM provisioning and then use `ansible` for the detailed VM configuration. The cloud provider for this project is `Linode`, the user with another cloud provider, please modify the terraform configuration to meet their cloud platform needs.

#### Prerequisite
Before we could start with the demo, the demo requires some basic setups
1. terraform installed
2. ansible installed
3. python 3+ installed

#### Initialzed and provisioning

1. Please create a `init.auto.tfvars` for storing neccessary secrete of variables. 
	```shell
	linode_token="{linode token}"
	root_pass="{VM root password}"
	ssh_key="{ssh access key}"
	```

	The project requires three terraform variables to be provided for making the terraform work well on provisioning.

2. Once the `init.auto.tfvars` ready, execute command to initialize the terraform project
	```shell
	terraform init
	```

3. After the terraform project is initialized, execute the command to apply the change to the cloud platform.
	```shell
	# auto-approve to prevent prompting the confirmation
	terraform apply --auto-approve
	```

4. Once the cloud VM is provisioned, we could start generating the required shell script for configuration of the project.
	```shell
	python main.py
	```

	After executing the above command you would observe a few files are generated(e.g. `inventory.yaml`, `init.sh`, `setup_hots.sh`, etc.).

	All the scripts are generated based on the IP address of new VM generated by the `terraform`, `init.sh` is the command initializing the whole configuration process.
	```shell
	source init.sh
	```

	After executing the command you would observe a list of operations happens, including,
	1. register `known_hosts`
	2. apply system update, installation of docker, and system configuration through `ansible`
	3. copy the docker compose to the remote VM through `SCP`

5. SSH into the remote server and start up the docker with `docker-compose.yaml`
	```shell
	# If executed `source init.sh`, the IP address of the VM is stored as environment variable in `ip`
	ssh root@$ip
	```

	execute the below command to start up the `sonarqube` server.
	```shel
	cd ~/sonarqube
	docker compose up
	```
	
6. After the command runs completes and shows the web server started. The user can access the sonarqube dashboard through the public IP address.
	```shell
	curl "http:$ip:9000"
	```

